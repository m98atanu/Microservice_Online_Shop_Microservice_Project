package com.microservices.cart.service;

import java.util.List;
import java.util.Optional;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;

import com.microservices.cart.DTO.UpdatedCartItemQuantityForLineItemId;
import com.microservices.cart.external.APIEndpoints.InventoryServiceEndpoints;
import com.microservices.cart.model.CartEntity;
import com.microservices.cart.model.LineItem;
import com.microservices.cart.repository.CartEntityRepository;
import com.microservices.cart.repository.LineItemRepository;

@Service
public class CartService {
	@Autowired
	CartEntityRepository cartRepo;
	
	@Autowired
	LineItemRepository lineItemRepo;
	
	@Autowired
	InventoryServiceEndpoints inventoryServiceEndpoints;
	
	public boolean isQuantityAvailableInInventoryDb (List<LineItem> items){
		if(items != null) {
			return items.stream()
					.allMatch(item ->
						item.getQuantity() < inventoryServiceEndpoints.fetchInventoryByProductId(item.getProductId()).getBody().getQuantity()
					);
		}
		else return true; //to tell to create empty cart
	}
	
	public int addCart(CartEntity cart) throws Exception{
		if(cart == null) throw new Exception("cart can't be null");
		if(isQuantityAvailableInInventoryDb(cart.getLineItems())) {
			return cartRepo.save(cart).getCartId();
		}
		else throw new Exception("quantity not available");
	}
	
	public CartEntity fetchCartByCartId(int cartId) throws Exception{
		Optional<CartEntity> cartInDbWithAskedCartId = cartRepo.findById(cartId);
		if(cartInDbWithAskedCartId.isPresent()) {
			return cartInDbWithAskedCartId.get();
		}
		else throw new Exception("Invalid CartId");
	}
	
	/*
	 * 1. Updating quantity count of an existing lineItem of cart's
	 */
	public String updateQuantityOfExistingLineItem(
			int cartId, UpdatedCartItemQuantityForLineItemId updatedCartItemQuantityForLineItemId 
			) throws Exception{
		Optional<CartEntity> cartInDbWithAskedId = cartRepo.findById(cartId);
		if(cartInDbWithAskedId.isPresent()) {
			List<LineItem> availableItemsList = cartInDbWithAskedId.get().getLineItems();
			
			Optional<Integer> itemIdToUpdate = availableItemsList.stream()
					.filter(item -> item.getItemId() == updatedCartItemQuantityForLineItemId.getItemId())
					.findFirst();
					
		}
				
					
	}
	
	
}
























